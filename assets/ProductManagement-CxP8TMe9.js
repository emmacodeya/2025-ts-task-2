import{a as K,r as f,d as O,u as E,o as q,b as Q,w as Y,c as Z,e as b,f as v,g as e,t as k,h as l,i as h,v as U,j as ee,k as te,l as le,m as H,F as I,n as F,p as V,q as G}from"./index-HlsQhara.js";import{M as oe,_ as se}from"./DeleteModal.vue_vue_type_script_setup_true_lang-B32OGWHH.js";const ae="https://ec-course-api.hexschool.io",D="emma9898",x=K.create({baseURL:ae});x.interceptors.request.use(o=>{const a=document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*=\s*([^;]*).*$)|^.*$/,"$1");return a&&(o.headers.Authorization=a),o},o=>Promise.reject(o));x.interceptors.response.use(o=>Promise.resolve(o),o=>Promise.reject(o.response.data));const ne=o=>x.get(`/v2/api/${D}/admin/products`,{params:o}),ie=o=>x.post(`/v2/api/${D}/admin/product`,{data:o}),re=o=>{const{data:a,id:g}=o;return x.put(`/v2/api/${D}/admin/product/${g}`,{data:a})},de=o=>x.delete(`/v2/api/${D}/admin/product/${o}`),ue=async o=>x.post(`/v2/api/${D}/admin/upload`,o),R=4;function ce(o){try{const a=new URL(o);return["http:","https:"].includes(a.protocol)}catch{return!1}}async function pe(o){const a=new FormData;a.append("file-to-upload",o);try{return(await ue(a)).data.imageUrl}catch(g){throw alert("上傳圖片失敗"),g}}function me(o=[]){const a=f([...o]),g=f(""),d=f("未選擇檔案。"),p=f(null),m=f(!1);return{uploadedImages:a,imageUrlInput:g,fileNameDisplay:d,fileToUpload:p,isUploading:m,addImageUrl:()=>{const u=g.value.trim();if(u){if(a.value.length>=R){alert(`最多只能上傳 ${R} 張圖片`);return}if(!ce(u)){alert("請輸入有效的圖片 URL 格式 (需包含 http:// 或 https://)");return}a.value.push(u),g.value=""}},handleFileChange:u=>{const n=u.target,i=n.files?.[0];if(n.value="",!i){d.value="未選擇檔案。",p.value=null;return}if(!i.type.startsWith("image/")){alert("請選擇有效的圖片檔案！"),d.value="未選擇檔案。",p.value=null;return}if(a.value.length>=R){alert(`最多只能上傳 ${R} 張圖片！`),d.value="圖片數量已達上限，請先刪除圖片。",p.value=null;return}p.value=i,d.value=i.name},triggerUpload:async()=>{const u=p.value;if(!u){alert("請先選擇圖片檔案");return}if(!m.value)try{m.value=!0;const n=await pe(u);a.value.push(n),p.value=null,d.value="未選擇檔案。",alert("圖片上傳成功！")}catch(n){console.error("圖片上傳失敗:",n),alert("圖片上傳失敗，請稍後再試。")}finally{m.value=!1}},deleteImage:u=>{a.value.splice(u,1)},resetImages:(u=[])=>{a.value=[...u].filter(Boolean),g.value="",d.value="未選擇檔案。",p.value=null,m.value=!1}}}const z=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]});function ge(){const o=f(z()),a=f("新增商品"),g=p=>{p?(o.value={...p},a.value="編輯商品"):d()},d=()=>{o.value=z(),a.value="新增商品"};return{form:o,formTitle:a,loadProduct:g,resetForm:d}}const fe={class:"modal-dialog modal-dialog-centered modal-lg"},be={class:"modal-content rounded-lg"},ve={class:"modal-header"},_e={class:"modal-title",id:"addNewProductModalLabel"},he={class:"modal-body"},ye={class:"row"},Ue={class:"col-md-6"},ke={class:"mb-3"},$e={class:"row"},xe={class:"col-6 mb-3"},we={class:"col-6 mb-3"},Ce={class:"row"},Pe={class:"col-6 mb-3"},Me={class:"col-6 mb-3"},Ie={class:"mb-3"},De={class:"mb-3"},Re={class:"mb-3 d-flex align-items-center"},Ve={class:"form-check form-switch"},Fe={class:"col-md-6"},Ne={class:"mb-3"},Se={class:"input-group mb-2"},je=["disabled"],Ee={class:"input-group mb-2"},Te={class:"file-name-display form-control rounded-lg"},Le=["disabled"],Ae={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Be={class:"mb-3"},Ge={id:"imagesContainer",class:"d-flex flex-wrap gap-2"},ze=["src"],Oe=["onClick"],qe=["src"],He={class:"modal-footer"},We=["disabled"],Xe=O({__name:"ProductModal",props:{product:{}},emits:["get-products"],setup(o,{expose:a,emit:g}){const d=g,p=E("modalRef");let m=null;q(()=>{p.value&&(m=new oe(p.value))}),Q(()=>{m?.dispose()});const w=()=>{m?.show()},y=()=>{m?.hide()},{form:r,formTitle:P,loadProduct:M}=ge(),{uploadedImages:u,imageUrlInput:n,fileToUpload:i,fileNameDisplay:c,isUploading:C,addImageUrl:T,triggerUpload:L,handleFileChange:A,deleteImage:W,resetImages:N}=me();Y(()=>o.product,$=>{$.id?(M($),N([$.imageUrl,...$.imagesUrl])):(M(null),N([]))},{immediate:!0,deep:!0});const X=Z(()=>!!o.product.id),S=f(!1),J=async()=>{const[$,...t]=u.value,{id:s,..._}=r.value;_.imageUrl=$,_.imagesUrl=t;const j={..._,imagesUrl:_.imagesUrl?.length?_.imagesUrl:[""]};S.value=!0;try{X.value&&s?await re({id:s,data:j}):await ie(j),N([]),y()}catch(B){B instanceof Error?alert(B.message):alert("新增 / 編輯產品失敗")}finally{S.value=!1,d("get-products")}};return a({openModal:w,closeModal:y}),($,t)=>(v(),b("div",{ref_key:"modalRef",ref:p,class:"modal fade",id:"addNewProductModal",tabindex:"-1","aria-labelledby":"addNewProductModalLabel","aria-hidden":"true"},[e("div",fe,[e("div",be,[e("div",ve,[e("h5",_e,k(l(P)),1),e("button",{onClick:y,type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]),e("div",he,[e("div",ye,[e("div",Ue,[e("form",null,[e("div",ke,[t[12]||(t[12]=e("label",{for:"productName",class:"form-label"},"商品名稱",-1)),h(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l(r).title=s),type:"text",class:"form-control rounded-lg",id:"productName"},null,512),[[U,l(r).title]])]),e("div",$e,[e("div",xe,[t[13]||(t[13]=e("label",{for:"productOriginalPrice",class:"form-label"},"原價",-1)),h(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>l(r).origin_price=s),type:"number",class:"form-control rounded-lg",id:"productOriginalPrice"},null,512),[[U,l(r).origin_price]])]),e("div",we,[t[14]||(t[14]=e("label",{for:"productPrice",class:"form-label"},"售價",-1)),h(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>l(r).price=s),type:"number",class:"form-control rounded-lg",id:"productPrice"},null,512),[[U,l(r).price]])])]),e("div",Ce,[e("div",Pe,[t[15]||(t[15]=e("label",{for:"productCategory",class:"form-label"},"分類",-1)),h(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>l(r).category=s),class:"form-control rounded-lg",id:"productCategory"},null,512),[[U,l(r).category]])]),e("div",Me,[t[16]||(t[16]=e("label",{for:"productUnit",class:"form-label"},"單位",-1)),h(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l(r).unit=s),class:"form-control rounded-lg",id:"productUnit"},null,512),[[U,l(r).unit]])])]),e("div",Ie,[t[17]||(t[17]=e("label",{for:"productDescription",class:"form-label"},"商品內容",-1)),h(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=s=>l(r).content=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[U,l(r).content]])]),e("div",De,[t[18]||(t[18]=e("label",{for:"productDescription",class:"form-label"},"商品描述",-1)),h(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=s=>l(r).description=s),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[U,l(r).description]])]),e("div",Re,[t[19]||(t[19]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",Ve,[h(e("input",{"onUpdate:modelValue":t[7]||(t[7]=s=>l(r).is_enabled=s),class:"form-check-input",type:"checkbox",id:"flexSwitchProductEnable","true-value":1,"false-value":0},null,512),[[ee,l(r).is_enabled]])])])])]),e("div",Fe,[e("div",Ne,[t[21]||(t[21]=e("label",{class:"form-label"},"上傳圖片 (最多 4 張)",-1)),e("div",Se,[h(e("input",{type:"url",class:"form-control rounded-lg",placeholder:"輸入圖片連結","onUpdate:modelValue":t[8]||(t[8]=s=>te(n)?n.value=s:null)},null,512),[[U,l(n)]]),e("button",{class:"btn btn-outline-secondary rounded-lg ms-2",type:"button",onClick:t[9]||(t[9]=(...s)=>l(T)&&l(T)(...s)),disabled:l(u).length>=4}," 新增連結 ",8,je)]),e("div",Ee,[t[20]||(t[20]=e("label",{class:"input-group-text rounded-lg",for:"imageInputFile"},"瀏覽...",-1)),e("input",{onChange:t[10]||(t[10]=(...s)=>l(A)&&l(A)(...s)),type:"file",class:"form-control d-none",id:"imageInputFile",accept:".jpg, .jpeg, .png"},null,32),e("div",Te,k(l(c)),1),e("button",{onClick:t[11]||(t[11]=(...s)=>l(L)&&l(L)(...s)),disabled:!l(i)||l(C)||l(u).length>=4,class:"btn btn-outline-secondary rounded-lg ms-2",type:"button"},[l(C)?(v(),b("span",Ae)):le("",!0),H(" "+k(l(C)?"上傳中...":"上傳圖片"),1)],8,Le)])]),e("div",Be,[t[23]||(t[23]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{class:"form-label mb-0"},"已上傳圖片")],-1)),e("div",Ge,[(v(!0),b(I,null,F(l(u),(s,_)=>(v(),b("div",{key:_,class:V(["image-preview-thumbnail-container",{"main-image":_===0}])},[e("img",{src:s,class:"image-preview-thumbnail",alt:"商品圖片預覽"},null,8,ze),e("button",{class:"btn btn-danger btn-sm delete-btn",onClick:j=>l(W)(_)},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])],8,Oe)],2))),128)),(v(!0),b(I,null,F(4-l(u).length,s=>(v(),b("div",{key:"placeholder-"+s,class:"image-preview-thumbnail-container"},[e("img",{src:`https://placehold.co/100x100/e9ecef/adb5bd?text=Image+${l(u).length+s}`,class:"image-preview-thumbnail"},null,8,qe)]))),128))])])])])]),e("div",He,[e("button",{onClick:y,type:"button",class:"btn btn-outline-secondary rounded-lg"}," 取消 "),e("button",{onClick:J,disabled:S.value,type:"button",class:"btn btn-dark rounded-lg"}," 儲存 ",8,We)])])])],512))}}),Je={class:"d-flex justify-content-end align-items-center mb-4"},Ke={class:"card shadow-sm rounded-lg flex-grow-1"},Qe={class:"card-body p-4"},Ye={class:"table-responsive"},Ze={class:"table table-hover align-middle"},et={class:"text-center"},tt={class:"form-check form-switch d-flex justify-content-center align-items-center"},lt=["checked"],ot={class:"text-nowrap"},st=["onClick"],at=["onClick"],nt={class:"d-flex justify-content-center mt-4"},it={class:"pagination"},rt={class:"page-item"},dt=["disabled"],ut=["onClick","disabled"],ct={class:"page-item"},pt=["disabled"],ft=O({__name:"ProductManagement",setup(o){const a=E("productModalRef"),g=E("deleteModalRef"),d=f("1"),p=f([]),m=f({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),w=async()=>{try{const n=await ne({page:d.value});p.value=n.data.products,m.value=n.data.pagination}catch(n){n instanceof Error?alert(n.message):alert("取得產品列表失敗")}};q(()=>{w()});const y=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]}),r=f(y()),P=(n=null)=>{n?r.value={...n,imagesUrl:n.imagesUrl?[...n.imagesUrl]:[""]}:r.value=y(),a.value?.openModal()},M=n=>{g.value?.openModal(()=>u(n))},u=async n=>{try{await de(n)}catch(i){i instanceof Error?alert(i.message):alert("刪除商品失敗")}finally{w()}};return(n,i)=>(v(),b(I,null,[e("div",Je,[e("button",{onClick:i[0]||(i[0]=c=>P(null)),type:"button",class:"btn btn-dark rounded-lg px-4 py-2"},[...i[3]||(i[3]=[e("i",{class:"fas fa-plus me-2"},null,-1),H("新增商品 ",-1)])])]),e("div",Ke,[e("div",Qe,[e("div",Ye,[e("table",Ze,[i[4]||(i[4]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"分類"),e("th",{scope:"col"},"商品名稱"),e("th",{scope:"col"},"原價"),e("th",{scope:"col"},"售價"),e("th",{scope:"col",class:"text-center"},"啟用"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(v(!0),b(I,null,F(p.value,c=>(v(),b("tr",{key:c.id},[e("td",null,k(c.category),1),e("td",null,k(c.title),1),e("td",null,k(c.origin_price),1),e("td",null,k(c.price),1),e("td",et,[e("div",tt,[e("input",{readonly:"",class:"form-check-input",style:{"pointer-events":"none"},type:"checkbox",id:"flexSwitchCheckDefault1",checked:!!c.is_enabled},null,8,lt)])]),e("td",ot,[e("button",{onClick:C=>P(c),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"}," 編輯 ",8,st),e("button",{onClick:C=>M(c.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"}," 刪除 ",8,at)])]))),128))])])]),e("nav",nt,[e("ul",it,[e("li",rt,[e("button",{onClick:i[1]||(i[1]=c=>d.value=String(Number(d.value)-1)),disabled:!m.value?.has_pre,type:"button",class:V(["page-link",{disabled:!m.value?.has_pre}]),"aria-label":"Previous"},[...i[5]||(i[5]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,dt)]),(v(!0),b(I,null,F(m.value?.total_pages,c=>(v(),b("li",{key:c,class:"page-item"},[e("button",{onClick:C=>d.value=c.toString(),disabled:d.value===c.toString(),type:"button",class:V(["page-link",{active:d.value===c.toString()}])},k(c),11,ut)]))),128)),e("li",ct,[e("button",{onClick:i[2]||(i[2]=c=>d.value=String(Number(d.value)+1)),disabled:!m.value?.has_next,class:V(["page-link",{disabled:!m.value?.has_next}]),type:"button","aria-label":"Next"},[...i[6]||(i[6]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,pt)])])])])]),G(Xe,{ref_key:"productModalRef",ref:a,product:r.value,onGetProducts:w},null,8,["product"]),G(se,{ref_key:"deleteModalRef",ref:g,title:"刪除商品",content:"確定要刪除該商品嗎？"},null,512)],64))}});export{ft as default};
